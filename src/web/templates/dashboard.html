{% extends "base.html" %}

{% block title %}Dashboard - Boxarr{% endblock %}

{% block styles %}
<style>
/* Dashboard Specific Styles */
.dashboard-header {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow);
    position: relative;
}

.dashboard-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.status-value {
    font-weight: 600;
    color: var(--text-primary);
}

.status-value.success {
    color: var(--success-color);
}

.status-value.error {
    color: var(--error-color);
}

.status-value.warning {
    color: var(--warning-color);
}

.status-value.highlight {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 700;
}

/* Status Explanation */
.status-explanation {
    background: var(--bg-color);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    border-left: 3px solid var(--primary-color);
}

.status-explanation strong {
    color: var(--text-primary);
    font-weight: 600;
}

.status-value[title] {
    cursor: help;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
}

.action-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-btn {
    padding: 0.75rem 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.action-btn:hover {
    background: var(--bg-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.action-btn.primary {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
}

.action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.report-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s;
    box-shadow: var(--shadow);
}

.report-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.report-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.report-date {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.report-stats {
    display: flex;
    justify-content: space-around;
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
}

.stat {
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: block;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-value.success {
    color: var(--success-color);
}

.report-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.report-actions {
    display: flex;
    gap: 0.75rem;
}

.report-btn {
    flex: 1;
    padding: 0.5rem;
    border-radius: 6px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    border: 1px solid var(--border-color);
}

.report-btn.view {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
}

.report-btn.view:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.report-btn.delete {
    background: var(--card-bg);
    color: var(--error-color);
    border-color: var(--error-color);
}

.report-btn.delete:hover {
    background: var(--error-color);
    color: white;
}

.older-weeks {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.older-weeks p {
    margin-bottom: 1rem;
    color: var(--text-secondary);
}

.week-selector {
    width: 100%;
    max-width: 400px;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 1rem;
    cursor: pointer;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-state h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.empty-state p {
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 1rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.action-btn.secondary {
    background: var(--bg-color);
}

/* Progress Modal */
.progress-modal {
    max-width: 600px;
}

.progress-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.progress-body {
    padding: 2rem;
    text-align: center;
}

.progress-spinner {
    margin-bottom: 1.5rem;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    margin: 0 auto;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.progress-status p {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.progress-details {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 1rem;
}

.progress-log {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.85rem;
    text-align: left;
}

.progress-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    text-align: center;
}

/* Pagination and Filter Styles */
.filter-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
}

.filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    justify-content: space-between;
}

.year-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.year-filter-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-right: 0.5rem;
}

.year-btn {
    padding: 0.5rem 1rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.year-btn:hover {
    background: var(--bg-color);
    transform: translateY(-1px);
}

.year-btn.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-color: transparent;
}

.page-size-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-size-selector label {
    font-weight: 500;
    color: var(--text-primary);
}

.page-size-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
    color: var(--text-primary);
    font-size: 0.95rem;
    cursor: pointer;
}

.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow);
}

.pagination {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.page-link {
    padding: 0.5rem 0.75rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 40px;
    text-align: center;
}

.page-link:hover:not(.disabled):not(.active) {
    background: var(--bg-color);
    transform: translateY(-1px);
}

.page-link.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-color: transparent;
}

.page-link.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0 1rem;
}

.filter-info {
    padding: 0.75rem;
    background: rgba(var(--primary-rgb), 0.05);
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Compact Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <span class="title-icon">üé¨</span>
            Boxarr Dashboard
        </h1>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Status:</span>
                <span class="status-value {% if radarr_configured %}success{% else %}error{% endif %}">
                    {% if radarr_configured %}‚úÖ Configured{% else %}‚ùå Not Configured{% endif %}
                </span>
            </div>
            
            <div class="status-item">
                <span class="status-label">Scheduler:</span>
                <span class="status-value {% if scheduler_enabled %}success{% else %}warning{% endif %}" 
                      title="{% if scheduler_enabled %}Automatic weekly fetching is enabled{% else %}Manual fetching only{% endif %}">
                    {% if scheduler_enabled %}‚úÖ Enabled{% else %}‚ö†Ô∏è Disabled{% endif %}
                </span>
            </div>
            
            <div class="status-item">
                <span class="status-label">Auto-Add:</span>
                <span class="status-value {% if auto_add %}success{% else %}warning{% endif %}" 
                      title="{% if auto_add %}Movies will be automatically added to Radarr when fetched{% else %}Movies must be manually added after fetching{% endif %}">
                    {% if auto_add %}‚úÖ Enabled{% else %}‚ö†Ô∏è Manual{% endif %}
                </span>
            </div>
            
            <div class="status-item">
                <span class="status-label">Next Update:</span>
                <span class="status-value" title="{% if scheduler_enabled %}Next scheduled box office data fetch{% else %}Scheduler is disabled{% endif %}">{{ next_update }}</span>
            </div>
            
            <div class="status-item">
                <span class="status-label">Weekly Pages:</span>
                <span class="status-value highlight">{{ total_all_weeks }}</span>
            </div>
        </div>
        
        <!-- Status Explanation -->
        <div class="status-explanation">
            <div style="padding: 0.75rem; background: rgba(var(--primary-rgb), 0.1); border-radius: 8px; font-size: 0.9rem;">
                <strong>Current behavior:</strong>
                {% if scheduler_enabled %}
                    üìÖ Scheduler runs every <strong>{{ next_update }}</strong>
                {% else %}
                    ‚è∏Ô∏è Scheduler is <strong>disabled</strong> - use manual fetch
                {% endif %}
                ‚Ä¢
                {% if auto_add %}
                    ‚úÖ Movies are <strong>added automatically</strong> when fetched
                    {% if auto_add_filters_active %}
                        <br><span style="margin-left: 1.5rem;">üéØ <strong>Filters active:</strong> {{ filter_descriptions | join(', ') }}</span>
                    {% endif %}
                {% else %}
                    üîò Movies require <strong>manual adding</strong> after fetch
                {% endif %}
            </div>
            
            {% if not radarr_configured %}
                <br><strong style="color: var(--error-color);">‚ö†Ô∏è Warning:</strong> Radarr is not configured. Please complete the setup first.
            {% endif %}
        </div>
        
        <!-- Action Buttons -->
        <div class="action-bar">
            <button class="action-btn" onclick="updateCurrentWeek()" 
                    title="{% if auto_add %}Fetch latest box office data and automatically add missing movies to Radarr{% else %}Fetch latest box office data (manual add required){% endif %}">
                <span class="btn-icon">üîÑ</span> Update Last Week
            </button>
            
            <button class="action-btn" onclick="showHistoricalUpdate()"
                    title="{% if auto_add %}Fetch historical box office data and automatically add missing movies to Radarr{% else %}Fetch historical box office data (manual add required){% endif %}">
                <span class="btn-icon">üìÖ</span> Update Historical Week
            </button>
            
            <!-- Fix Missing Data Button (only shows when needed) -->
            <button id="fixMissingDataBtn" class="action-btn fix-missing-data" 
                    style="display: none; background: linear-gradient(135deg, #f59e0b, #ea580c); color: white;"
                    onclick="fixMissingData()"
                    title="Fix missing movie metadata (posters, genres, etc.)">
                <span class="btn-icon">üîß</span> 
                <span id="fixMissingDataText">Fix Missing Data</span>
            </button>
            
            {% if recent_weeks %}
            <a href="{{ request.scope.get('root_path', '') }}/{{ recent_weeks[0].year }}W{{ '%02d'|format(recent_weeks[0].week) }}" class="action-btn primary">
                <span class="btn-icon">üëÅÔ∏è</span> View Last Week
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Filters and Pagination Controls -->
    {% if weeks %}
    <div class="filter-section">
        <div class="filter-controls">
            <div class="year-filters">
                <span class="year-filter-label">Filter by year:</span>
                <a href="{{ request.scope.get('root_path', '') }}/weeks?page=1&per_page={{ per_page }}" 
                   class="year-btn {% if not year_filter %}active{% endif %}">All</a>
                {% for year in available_years %}
                <a href="{{ request.scope.get('root_path', '') }}/weeks?year={{ year }}&page=1&per_page={{ per_page }}" 
                   class="year-btn {% if year_filter == year %}active{% endif %}">{{ year }}</a>
                {% endfor %}
            </div>
            
            <div class="page-size-selector">
                <label for="perPageSelect">Show:</label>
                <select id="perPageSelect" class="page-size-select" onchange="changePageSize(this.value)">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10 per page</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20 per page</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                </select>
            </div>
        </div>
        
        {% if year_filter %}
        <div class="filter-info">
            <strong>Showing {{ total_weeks }} weeks from {{ year_filter }}</strong>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Weekly Reports -->
    <div class="reports-container">
        {% if weeks %}
            <h2 class="section-title">Weekly Box Office Reports</h2>
            
            <div class="reports-grid">
                {% for week in paginated_weeks %}
                <div class="report-card">
                    <div class="report-header">
                        <h3>Week {{ "%02d"|format(week.week) }}, {{ week.year }}</h3>
                        <span class="report-date">{{ week.date_range }}</span>
                    </div>
                    
                    <div class="report-stats">
                        <div class="stat">
                            <span class="stat-label">MOVIES</span>
                            <span class="stat-value">{{ week.movie_count }}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">MATCHED</span>
                            <span class="stat-value success">{{ week.matched_count }}</span>
                        </div>
                    </div>
                    
                    <div class="report-meta">
                        <span class="meta-icon">üïê</span>
                        <span class="meta-text">{{ week.timestamp_str or 'Unknown' }}</span>
                    </div>
                    
                    <div class="report-actions">
                        <a href="{{ request.scope.get('root_path', '') }}/{{ week.year }}W{{ '%02d'|format(week.week) }}" class="report-btn view">View</a>
                        <button class="report-btn delete" onclick="deleteWeek('{{ week.year }}', '{{ '%02d'|format(week.week) }}')">Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if total_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination">
                    <!-- Previous button -->
                    {% if current_page > 1 %}
                    <a href="{{ request.scope.get('root_path', '') }}/weeks?page={{ current_page - 1 }}&per_page={{ per_page }}{% if year_filter %}&year={{ year_filter }}{% endif %}" 
                       class="page-link">‚Üê Previous</a>
                    {% else %}
                    <span class="page-link disabled">‚Üê Previous</span>
                    {% endif %}
                    
                    <!-- Page numbers -->
                    {% set start_page = current_page - 2 %}
                    {% if start_page < 1 %}{% set start_page = 1 %}{% endif %}
                    {% set end_page = current_page + 2 %}
                    {% if end_page > total_pages %}{% set end_page = total_pages %}{% endif %}
                    
                    {% if start_page > 1 %}
                    <a href="{{ request.scope.get('root_path', '') }}/weeks?page=1&per_page={{ per_page }}{% if year_filter %}&year={{ year_filter }}{% endif %}" 
                       class="page-link">1</a>
                    {% if start_page > 2 %}
                    <span class="page-link disabled">...</span>
                    {% endif %}
                    {% endif %}
                    
                    {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == current_page %}
                    <span class="page-link active">{{ page_num }}</span>
                    {% else %}
                    <a href="{{ request.scope.get('root_path', '') }}/weeks?page={{ page_num }}&per_page={{ per_page }}{% if year_filter %}&year={{ year_filter }}{% endif %}" 
                       class="page-link">{{ page_num }}</a>
                    {% endif %}
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                    <span class="page-link disabled">...</span>
                    {% endif %}
                    <a href="{{ request.scope.get('root_path', '') }}/weeks?page={{ total_pages }}&per_page={{ per_page }}{% if year_filter %}&year={{ year_filter }}{% endif %}" 
                       class="page-link">{{ total_pages }}</a>
                    {% endif %}
                    
                    <!-- Next button -->
                    {% if current_page < total_pages %}
                    <a href="{{ request.scope.get('root_path', '') }}/weeks?page={{ current_page + 1 }}&per_page={{ per_page }}{% if year_filter %}&year={{ year_filter }}{% endif %}" 
                       class="page-link">Next ‚Üí</a>
                    {% else %}
                    <span class="page-link disabled">Next ‚Üí</span>
                    {% endif %}
                </div>
                
                <span class="page-info">
                    Page {{ current_page }} of {{ total_pages }} | Showing {{ paginated_weeks|length }} of {{ total_weeks }} weeks
                </span>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <h2>Welcome to Boxarr</h2>
                <p>Fetch last week's box office data to start tracking popular movies</p>
                <button class="action-btn primary" onclick="updateCurrentWeek()">
                    <span class="btn-icon">üé¨</span> Fetch Last Week's Data
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Historical Update Modal -->
<div id="historicalModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Historical Data</h3>
            <button class="modal-close" onclick="closeHistoricalUpdate()">&times;</button>
        </div>
        
        <!-- Mode Switcher -->
        <div class="mode-switcher">
            <button class="mode-btn active" data-mode="single" onclick="switchMode('single')">Single Week</button>
            <button class="mode-btn" data-mode="range" onclick="switchMode('range')">Week Range</button>
        </div>
        
        <div class="modal-body">
            <!-- Single Week Mode -->
            <div class="mode-panel" id="singleModePanel">
                <div class="form-group">
                    <label for="historicalYear">Year</label>
                    <select id="historicalYear" class="form-select">
                        {% for year in range(current_year, 2019, -1) %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="historicalWeek">Week</label>
                    <select id="historicalWeek" class="form-select">
                        {% for week in range(1, 53) %}
                        <option value="{{ week }}">Week {{ "%02d"|format(week) }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Range Mode -->
            <div class="mode-panel" id="rangeModePanel" style="display: none;">
                <div class="range-inputs">
                    <div class="range-group">
                        <label>From</label>
                        <div class="range-selects">
                            <select id="startYear" class="form-select">
                                {% for year in range(current_year, 2019, -1) %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <select id="startWeek" class="form-select">
                                {% for week in range(1, 53) %}
                                <option value="{{ week }}">W{{ "%02d"|format(week) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="range-group">
                        <label>To</label>
                        <div class="range-selects">
                            <select id="endYear" class="form-select">
                                {% for year in range(current_year, 2019, -1) %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <select id="endWeek" class="form-select">
                                {% for week in range(1, 53) %}
                                <option value="{{ week }}">W{{ "%02d"|format(week) }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Presets -->
                <div class="quick-presets">
                    <label>Quick Select:</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="setPreset('last4')">Last 4 Weeks</button>
                        <button class="preset-btn" onclick="setPreset('last8')">Last 8 Weeks</button>
                        <button class="preset-btn" onclick="setPreset('thisYear')">This Year</button>
                        <button class="preset-btn" onclick="setPreset('lastQuarter')">Last Quarter</button>
                    </div>
                </div>
                
                <!-- Range Summary -->
                <div class="range-summary" id="rangeSummary">
                    <div class="summary-text">
                        <span id="weekCount">0</span> weeks selected
                        <span class="date-range" id="dateRange"></span>
                    </div>
                    <div class="existing-weeks-info" id="existingWeeksInfo" style="display: none;">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span id="existingCount">0</span> weeks already exist and will be updated
                    </div>
                </div>
            </div>
            
            <!-- Current Behavior Section -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; border: 1px solid rgba(var(--primary-rgb), 0.2);">
                <p style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem;">
                    <strong>üìä Current behavior:</strong>
                </p>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    {% if auto_add %}
                        ‚úÖ Auto-add is <strong style="color: var(--success-color);">ENABLED</strong> - Movies will be automatically added to Radarr
                        {% if auto_add_filters_active %}
                            <br>üéØ <strong>Filters active:</strong> {{ filter_descriptions | join(', ') }}
                        {% endif %}
                    {% else %}
                        üîò Auto-add is <strong style="color: var(--warning-color);">DISABLED</strong> - Movies will NOT be automatically added
                    {% endif %}
                    
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-primary);">
                        üí° <strong>Note:</strong> This behavior applies to all historical fetches. You can change these settings in <a href="{{ request.scope.get('root_path', '') }}/setup" style="color: var(--primary-color); text-decoration: underline;">Settings</a>.
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary" onclick="closeHistoricalUpdate()">Cancel</button>
            <button class="action-btn primary" id="updateButton" onclick="handleUpdate()">Update Week</button>
        </div>
    </div>
</div>

<!-- Historical Week Confirmation Modal -->
<div id="historicalWeekModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="historicalWeekTitle">Fetch Historical Week Data</h3>
            <button class="modal-close" onclick="closeHistoricalWeekModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="padding: 1rem; background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; margin-bottom: 1.5rem;">
                <p style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem;">
                    <strong>üìä What will happen:</strong>
                </p>
                <ol style="font-size: 0.9rem; color: var(--text-secondary); margin: 0; padding-left: 1.5rem;">
                    <li>Fetch box office data for <strong id="selectedWeekText">the selected week</strong></li>
                    <li>Match movies against your Radarr library</li>
                    <li id="autoAddBehavior" style="font-weight: 600;">
                        {% if auto_add %}
                            <span style="color: var(--success-color);">‚úÖ Missing movies will be AUTOMATICALLY added
                            {% if auto_add_filters_active %}
                                <br><span style="margin-left: 1rem;">üéØ With filters: {{ filter_descriptions | join(', ') }}</span>
                            {% endif %}
                            </span>
                        {% else %}
                            <span style="color: var(--warning-color);">üîò Movies will NOT be automatically added</span>
                        {% endif %}
                    </li>
                </ol>
            </div>
            
            <div style="padding: 0.75rem; background: rgba(var(--info-rgb, 59, 130, 246), 0.1); border-radius: 8px; border: 1px solid rgba(var(--info-rgb, 59, 130, 246), 0.2);">
                <p style="font-size: 0.85rem; color: var(--text-primary); margin: 0;">
                    üí° <strong>Tip:</strong> To change auto-add behavior or filters, visit <a href="{{ request.scope.get('root_path', '') }}/setup" style="color: var(--primary-color); text-decoration: underline;">Settings</a>.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary" onclick="closeHistoricalWeekModal()">Cancel</button>
            <button class="action-btn primary" onclick="fetchHistoricalWeek()">Fetch Week Data</button>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div id="progressModal" class="modal">
    <div class="modal-content progress-modal">
        <div class="progress-header">
            <h3 id="progressTitle">Updating Box Office Data</h3>
        </div>
        <div class="progress-body">
            <div class="progress-spinner" id="progressSpinner">
                <div class="spinner"></div>
            </div>
            <div class="progress-status">
                <p id="progressMessage">Fetching box office data from Box Office Mojo...</p>
                <div class="progress-details" id="progressDetails"></div>
            </div>
            
            <!-- Multi-week Progress Bar -->
            <div class="multi-week-progress" id="multiWeekProgress" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> weeks processed
                    </div>
                </div>
                <div class="current-week-info" id="currentWeekInfo">
                    Processing: <span id="currentWeekText"></span>
                </div>
            </div>
            
            <div class="progress-log" id="progressLog"></div>
        </div>
        <div class="progress-footer" id="progressFooter" style="display: none;">
            <button class="action-btn secondary" id="cancelButton" onclick="cancelRangeUpdate()" style="display: none;">Cancel</button>
            <button class="action-btn primary" onclick="closeProgressModal()">Close</button>
        </div>
    </div>
</div>

<!-- Range Update Summary Modal -->
<div id="summaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Range Update Complete</h3>
            <button class="modal-close" onclick="closeSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="summary-stats">
                <div class="stat-card success">
                    <div class="stat-value" id="summarySuccess">0</div>
                    <div class="stat-label">Weeks Updated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="summaryMovies">0</div>
                    <div class="stat-label">Movies Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="summaryAdded">0</div>
                    <div class="stat-label">Movies Added</div>
                </div>
            </div>
            
            <div class="failed-weeks" id="failedWeeks" style="display: none;">
                <h4>Failed Weeks (<span id="failedCount">0</span>)</h4>
                <ul id="failedList"></ul>
            </div>
            
            <div class="summary-details" id="summaryDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary" onclick="closeSummaryModal()">Close</button>
            <button class="action-btn primary" onclick="location.reload()">Refresh Dashboard</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ensure apiUrl function is available (fallback if app.js hasn't loaded yet)
if (typeof apiUrl === 'undefined') {
    window.apiUrl = function(endpoint) {
        // Get base path from request scope or default to empty
        const basePath = '{{ request.scope.get("root_path", "") }}';
        // Ensure endpoint starts with /
        if (!endpoint.startsWith('/')) {
            endpoint = '/' + endpoint;
        }
        return basePath + '/api' + endpoint;
    };
}

// Historical Range Update Implementation
class RangeProcessor {
    constructor() {
        this.weeks = [];
        this.current = 0;
        this.results = [];
        this.cancelled = false;
        this.existingWeeks = new Set();
    }
    
    calculateWeeks(startYear, startWeek, endYear, endWeek) {
        const weeks = [];
        let current = new Date(startYear, 0, 1 + (startWeek - 1) * 7);
        const end = new Date(endYear, 0, 1 + (endWeek - 1) * 7);
        
        while (current <= end) {
            const year = current.getFullYear();
            const week = this.getWeekNumber(current);
            weeks.push({year, week});
            current.setDate(current.getDate() + 7);
        }
        
        return weeks;
    }
    
    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    async checkExistingWeeks() {
        // In a real implementation, this would check the server
        // For now, we'll check the DOM for existing week cards
        const weekCards = document.querySelectorAll('.report-card');
        weekCards.forEach(card => {
            const h3 = card.querySelector('h3');
            if (h3) {
                const match = h3.textContent.match(/Week (\d+), (\d+)/);
                if (match) {
                    const week = parseInt(match[1]);
                    const year = parseInt(match[2]);
                    this.existingWeeks.add(`${year}W${week.toString().padStart(2, '0')}`);
                }
            }
        });
    }
    
    async processRange(startYear, startWeek, endYear, endWeek) {
        this.weeks = this.calculateWeeks(startYear, startWeek, endYear, endWeek);
        this.results = [];
        this.cancelled = false;
        
        // Check existing weeks
        await this.checkExistingWeeks();
        
        // Show progress UI
        this.showProgressBar();
        
        for (let i = 0; i < this.weeks.length; i++) {
            if (this.cancelled) {
                break;
            }
            
            const {year, week} = this.weeks[i];
            const weekStr = `${year}W${week.toString().padStart(2, '0')}`;
            
            // Update progress
            this.updateProgress(i, `Processing ${weekStr}...`);
            
            try {
                const response = await fetch(apiUrl('/scheduler/update-week'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({year, week})
                });
                
                const data = await response.json();
                this.results.push({year, week, ...data});
                
                // Update progress bar
                this.updateProgress(i + 1, `Completed ${weekStr}`);
                
                // Small delay between requests
                if (i < this.weeks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            } catch (error) {
                console.error(`Error processing week ${weekStr}:`, error);
                this.results.push({
                    year,
                    week,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.showSummary();
    }
    
    showProgressBar() {
        const modal = document.getElementById('progressModal');
        const multiWeekProgress = document.getElementById('multiWeekProgress');
        const progressSpinner = document.getElementById('progressSpinner');
        const cancelButton = document.getElementById('cancelButton');
        
        modal.style.display = 'flex';
        multiWeekProgress.style.display = 'block';
        progressSpinner.style.display = 'block';
        cancelButton.style.display = 'inline-block';
        
        document.getElementById('progressTotal').textContent = this.weeks.length;
        document.getElementById('progressCurrent').textContent = '0';
        document.getElementById('progressTitle').textContent = 'Updating Historical Range';
    }
    
    updateProgress(current, message) {
        const percent = (current / this.weeks.length) * 100;
        document.getElementById('progressBarFill').style.width = `${percent}%`;
        document.getElementById('progressCurrent').textContent = current;
        document.getElementById('currentWeekText').textContent = message;
        
        // Add to log
        const log = document.getElementById('progressLog');
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }
    
    showSummary() {
        // Hide progress modal
        document.getElementById('progressModal').style.display = 'none';
        
        // Calculate summary stats
        const successful = this.results.filter(r => r.success).length;
        const failed = this.results.filter(r => !r.success);
        const totalMovies = this.results.reduce((sum, r) => sum + (r.movies_found || 0), 0);
        const totalAdded = this.results.reduce((sum, r) => sum + (r.movies_added || 0), 0);
        
        // Update summary modal
        document.getElementById('summarySuccess').textContent = successful;
        document.getElementById('summaryMovies').textContent = totalMovies;
        document.getElementById('summaryAdded').textContent = totalAdded;
        
        // Show failed weeks if any
        if (failed.length > 0) {
            document.getElementById('failedWeeks').style.display = 'block';
            document.getElementById('failedCount').textContent = failed.length;
            const failedList = document.getElementById('failedList');
            failedList.innerHTML = '';
            failed.forEach(f => {
                const li = document.createElement('li');
                li.textContent = `${f.year}W${f.week.toString().padStart(2, '0')}: ${f.error || 'Unknown error'}`;
                failedList.appendChild(li);
            });
        } else {
            document.getElementById('failedWeeks').style.display = 'none';
        }
        
        // Show summary modal
        document.getElementById('summaryModal').style.display = 'flex';
    }
    
    cancel() {
        this.cancelled = true;
        const log = document.getElementById('progressLog');
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] Update cancelled by user`;
        entry.style.color = 'var(--warning-color)';
        log.appendChild(entry);
    }
}

// Global instance
const rangeProcessor = new RangeProcessor();

// Mode switching
let currentMode = 'single';

function switchMode(mode) {
    currentMode = mode;
    
    // Update button states
    document.querySelectorAll('.mode-btn').forEach(btn => {
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Show/hide panels
    if (mode === 'single') {
        document.getElementById('singleModePanel').style.display = 'block';
        document.getElementById('rangeModePanel').style.display = 'none';
        document.getElementById('updateButton').textContent = 'Update Week';
    } else {
        document.getElementById('singleModePanel').style.display = 'none';
        document.getElementById('rangeModePanel').style.display = 'block';
        document.getElementById('updateButton').textContent = 'Update Range';
        updateRangeSummary();
    }
}

// Range calculation and validation
function updateRangeSummary() {
    const startYear = parseInt(document.getElementById('startYear').value);
    const startWeek = parseInt(document.getElementById('startWeek').value);
    const endYear = parseInt(document.getElementById('endYear').value);
    const endWeek = parseInt(document.getElementById('endWeek').value);
    
    const weeks = rangeProcessor.calculateWeeks(startYear, startWeek, endYear, endWeek);
    document.getElementById('weekCount').textContent = weeks.length;
    
    // Calculate date range
    const startDate = new Date(startYear, 0, 1 + (startWeek - 1) * 7);
    const endDate = new Date(endYear, 0, 1 + (endWeek - 1) * 7 + 6);
    
    const dateRange = `${startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
    document.getElementById('dateRange').textContent = dateRange;
    
    // Check for existing weeks
    rangeProcessor.checkExistingWeeks().then(() => {
        const existingCount = weeks.filter(w => {
            const weekStr = `${w.year}W${w.week.toString().padStart(2, '0')}`;
            return rangeProcessor.existingWeeks.has(weekStr);
        }).length;
        
        if (existingCount > 0) {
            document.getElementById('existingWeeksInfo').style.display = 'flex';
            document.getElementById('existingCount').textContent = existingCount;
        } else {
            document.getElementById('existingWeeksInfo').style.display = 'none';
        }
    });
}

// Quick presets
function setPreset(preset) {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentWeek = rangeProcessor.getWeekNumber(now);
    
    let startYear, startWeek, endYear, endWeek;
    
    switch(preset) {
        case 'last4':
            endYear = currentYear;
            endWeek = currentWeek - 1; // Last complete week
            if (endWeek < 1) {
                endYear--;
                endWeek = 52;
            }
            startWeek = endWeek - 3;
            startYear = endYear;
            if (startWeek < 1) {
                startYear--;
                startWeek = 52 + startWeek;
            }
            break;
            
        case 'last8':
            endYear = currentYear;
            endWeek = currentWeek - 1;
            if (endWeek < 1) {
                endYear--;
                endWeek = 52;
            }
            startWeek = endWeek - 7;
            startYear = endYear;
            if (startWeek < 1) {
                startYear--;
                startWeek = 52 + startWeek;
            }
            break;
            
        case 'thisYear':
            startYear = currentYear;
            startWeek = 1;
            endYear = currentYear;
            endWeek = currentWeek - 1;
            break;
            
        case 'lastQuarter':
            const quarterEnd = Math.floor((currentWeek - 1) / 13) * 13;
            endYear = currentYear;
            endWeek = quarterEnd || 52;
            if (endWeek === 52) endYear--;
            startYear = endYear;
            startWeek = Math.max(1, endWeek - 12);
            break;
    }
    
    // Set the values
    document.getElementById('startYear').value = startYear;
    document.getElementById('startWeek').value = startWeek;
    document.getElementById('endYear').value = endYear;
    document.getElementById('endWeek').value = endWeek;
    
    // Update summary
    updateRangeSummary();
}

// Event listeners for range changes
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for range selects
    const rangeSelects = ['startYear', 'startWeek', 'endYear', 'endWeek'];
    rangeSelects.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updateRangeSummary);
        }
    });
    
    // Check for missing metadata on page load
    checkMissingMetadata();
});

// Main update handler
function handleUpdate() {
    if (currentMode === 'single') {
        updateHistoricalWeek();
    } else {
        updateHistoricalRange();
    }
}

// Update historical range
async function updateHistoricalRange() {
    const startYear = parseInt(document.getElementById('startYear').value);
    const startWeek = parseInt(document.getElementById('startWeek').value);
    const endYear = parseInt(document.getElementById('endYear').value);
    const endWeek = parseInt(document.getElementById('endWeek').value);
    
    // Validate range
    if (startYear > endYear || (startYear === endYear && startWeek > endWeek)) {
        alert('Invalid range: Start date must be before end date');
        return;
    }
    
    const weeks = rangeProcessor.calculateWeeks(startYear, startWeek, endYear, endWeek);
    if (weeks.length > 52) {
        if (!confirm(`This will update ${weeks.length} weeks. This may take several minutes. Continue?`)) {
            return;
        }
    }
    
    // Close the modal
    closeHistoricalUpdate();
    
    // Start processing
    await rangeProcessor.processRange(startYear, startWeek, endYear, endWeek);
}

// Cancel range update
function cancelRangeUpdate() {
    rangeProcessor.cancel();
    document.getElementById('cancelButton').style.display = 'none';
    document.getElementById('progressFooter').style.display = 'block';
}

// Close summary modal
function closeSummaryModal() {
    document.getElementById('summaryModal').style.display = 'none';
}

// Original single-week functions (keeping existing functionality)
function showHistoricalUpdate() {
    document.getElementById('historicalModal').style.display = 'flex';
}

function closeHistoricalUpdate() {
    document.getElementById('historicalModal').style.display = 'none';
}

function updateCurrentWeek() {
    showProgress('Updating Last Week');
    addToProgressLog('Starting update for last week...');
    
    fetch(apiUrl('/scheduler/trigger'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            addToProgressLog(`Update completed successfully! Found ${data.movies_found || 0} movies.`);
            if (data.movies_added > 0) {
                addToProgressLog(`Added ${data.movies_added} movies to Radarr.`);
            }
            showSuccess(`Updated successfully! Found ${data.movies_found || 0} movies.`);
            setTimeout(() => location.reload(), 2000);
        } else {
            addToProgressLog(`Update failed: ${data.message || 'Unknown error'}`, 'error');
            showError('Update failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        const errorMsg = error.message || 'Network error';
        addToProgressLog(`Error: ${errorMsg}`, 'error');
        showError('Update failed: ' + errorMsg);
    });
}

function updateHistoricalWeek() {
    const year = document.getElementById('historicalYear').value;
    const week = document.getElementById('historicalWeek').value;
    
    closeHistoricalUpdate();
    showProgress(`Updating Week ${week}, ${year}`);
    addToProgressLog(`Starting update for Week ${week}, ${year}...`);
    
    fetch(apiUrl('/scheduler/update-week'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({year: parseInt(year), week: parseInt(week)})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            addToProgressLog(`Update completed successfully! Found ${data.movies_found || 0} movies.`);
            if (data.movies_added > 0) {
                addToProgressLog(`Added ${data.movies_added} movies to Radarr.`);
            }
            showSuccess(`Updated successfully! Found ${data.movies_found || 0} movies.`);
            setTimeout(() => location.reload(), 2000);
        } else {
            addToProgressLog(`Update failed: ${data.message || 'Unknown error'}`, 'error');
            showError('Update failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        const errorMsg = error.message || 'Network error';
        addToProgressLog(`Error: ${errorMsg}`, 'error');
        showError('Update failed: ' + errorMsg);
    });
}

function closeHistoricalWeekModal() {
    document.getElementById('historicalWeekModal').style.display = 'none';
}

function fetchHistoricalWeek() {
    // This function is referenced but needs implementation
    updateHistoricalWeek();
}

async function deleteWeek(year, week) {
    if (!confirm(`Are you sure you want to delete Week ${week}, ${year}?`)) {
        return;
    }
    
    try {
        const response = await fetch(apiUrl(`/weeks/${year}/W${week}/delete`), {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Successfully deleted Week ${week}, ${year}`);
            // Reload the page to reflect the changes
            window.location.reload();
        } else {
            alert(`Failed to delete week: ${data.message || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error deleting week:', error);
        alert(`Error deleting week: ${error.message}`);
    }
}

// Check for missing metadata
async function checkMissingMetadata() {
    try {
        const response = await fetch(apiUrl('/admin/check-missing-metadata'));
        const data = await response.json();
        
        if (data.has_issues) {
            // Show the fix button with count
            const btn = document.getElementById('fixMissingDataBtn');
            const text = document.getElementById('fixMissingDataText');
            if (btn && text) {
                btn.style.display = 'inline-flex';
                text.textContent = `Fix Missing Data (${data.unique_movies_missing_data} movies)`;
                btn.title = `Fix ${data.unique_movies_missing_data} movies missing metadata across ${data.weeks_with_issues} weeks`;
            }
        }
    } catch (error) {
        console.error('Error checking missing metadata:', error);
    }
}

// Fix missing metadata
async function fixMissingData() {
    if (!confirm('This will fetch TMDB data for all movies with missing posters or metadata. Continue?')) {
        return;
    }
    
    // Show progress modal
    showProgress('Fixing missing movie metadata...');
    addToProgressLog('Starting metadata repair process...');
    
    try {
        const response = await fetch(apiUrl('/admin/repair-missing-metadata'), {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                dry_run: false,
                rate_limit_delay: 250
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Handle Server-Sent Events stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            addToProgressLog(`Error: ${data.error}`, 'error');
                            showError(`Failed: ${data.error}`);
                            return;
                        }
                        
                        // Update progress based on stage
                        if (data.stage === 'scanning') {
                            const progressText = data.progress ? ` (${data.progress}/${data.total})` : '';
                            addToProgressLog(`Scanning: ${data.message}${progressText}`);
                        } else if (data.stage === 'fetching') {
                            addToProgressLog(data.message);
                            // Update main progress message with current movie
                            document.getElementById('progressMessage').textContent = data.message;
                        } else if (data.stage === 'updating') {
                            addToProgressLog(data.message);
                            document.getElementById('progressMessage').textContent = data.message;
                        } else if (data.stage === 'complete') {
                            if (data.success) {
                                showSuccess(data.message);
                                
                                if (data.errors && data.errors.length > 0) {
                                    addToProgressLog('', 'info');
                                    addToProgressLog('Some movies could not be fixed:', 'warning');
                                    data.errors.forEach(err => addToProgressLog(`  - ${err}`, 'warning'));
                                }
                                
                                // Add reload button
                                setTimeout(() => {
                                    addToProgressLog('', 'info');
                                    addToProgressLog('Refreshing page to show updated data...', 'success');
                                    setTimeout(() => window.location.reload(), 2000);
                                }, 1000);
                            } else {
                                showError(data.message || 'Unknown error');
                            }
                            return;
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e, line);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error fixing metadata:', error);
        addToProgressLog(`Error: ${error.message}`, 'error');
        showError(`Error fixing metadata: ${error.message}`);
    }
}

function changePageSize(size) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', size);
    url.searchParams.set('page', '1');
    window.location = url;
}

// Progress modal functions
function showProgress(message) {
    const modal = document.getElementById('progressModal');
    const progressMessage = document.getElementById('progressMessage');
    const multiWeekProgress = document.getElementById('multiWeekProgress');
    const progressSpinner = document.getElementById('progressSpinner');
    const progressLog = document.getElementById('progressLog');
    
    modal.style.display = 'flex';
    progressMessage.textContent = message;
    multiWeekProgress.style.display = 'none';
    progressSpinner.style.display = 'block';
    
    // Clear previous log entries
    progressLog.innerHTML = '';
    progressLog.style.display = 'block';
}

// Helper function to add entries to progress log
function addToProgressLog(message, type = 'info') {
    const log = document.getElementById('progressLog');
    const entry = document.createElement('div');
    const timestamp = new Date().toLocaleTimeString();
    entry.textContent = `[${timestamp}] ${message}`;
    
    if (type === 'error') {
        entry.style.color = 'var(--error-color)';
    } else if (type === 'warning') {
        entry.style.color = 'var(--warning-color)';
    } else if (type === 'success') {
        entry.style.color = 'var(--success-color)';
    }
    
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function showSuccess(message) {
    const modal = document.getElementById('progressModal');
    const progressMessage = document.getElementById('progressMessage');
    const progressFooter = document.getElementById('progressFooter');
    const progressSpinner = document.getElementById('progressSpinner');
    
    progressMessage.innerHTML = `<span style="color: var(--success-color);">‚úÖ ${message}</span>`;
    progressSpinner.style.display = 'none';
    progressFooter.style.display = 'block';
    
    // Also add to log
    addToProgressLog(message, 'success');
}

function showError(message) {
    const modal = document.getElementById('progressModal');
    const progressMessage = document.getElementById('progressMessage');
    const progressFooter = document.getElementById('progressFooter');
    const progressSpinner = document.getElementById('progressSpinner');
    
    progressMessage.innerHTML = `<span style="color: var(--error-color);">‚ùå ${message}</span>`;
    progressSpinner.style.display = 'none';
    progressFooter.style.display = 'block';
    
    // Also add to log
    addToProgressLog(message, 'error');
}

function closeProgressModal() {
    document.getElementById('progressModal').style.display = 'none';
    document.getElementById('progressFooter').style.display = 'none';
}
</script>
{% endblock %}